/* core.js - CV Portfolio Core Script */
/* This file is generated - translations come from config.json */

// TRANSLATIONS - Injected by generate.js
const translations = {
  "es": {
    "nav.home": "Inicio",
    "nav.about": "Perfil",
    "nav.education": "Formacion",
    "nav.experience": "Experiencia",
    "nav.contact": "Contacto",
    "hero.name": "Dr. Scarlet Perez",
    "hero.subtitle": "MEDICO ESTETICO | CIRUJANO",
    "hero.cta": "CONTACTAR",
    "hero.uni": "Universidad Catolica Boliviana San Pablo",
    "hero.college_name": "Colegio Medico de Barcelona",
    "hero.col_num": "Colegiada no 69466",
    "about.title": "Perfil Profesional",
    "about.desc": "Medico Cirujano con titulacion homologada en Espana. Actualmente ampliando especializacion con Masters en Medicina Estetica y Restauracion Capilar. Experiencia practica en atencion clinica, urgencias y coordinacion de pacientes. Comprometida con la excelencia medica y el trato humano.",
    "exp.title": "Experiencia Profesional",
    "exp.1.date": "2022",
    "exp.1.place": "Caja Nacional de Salud - Bolivia",
    "exp.1.role": "Internado Rotatorio Medico",
    "exp.1.desc": "Rotaciones completas en Cirugia, Pediatria, Ginecologia y Medicina Interna.",
    "exp.2.date": "2020 - 2022",
    "exp.2.place": "Feria Expocruz",
    "exp.2.role": "Medico de Apoyo / Urgencias",
    "exp.2.desc": "Atencion primaria de urgencias, triaje y estabilizacion.",
    "exp.3.date": "2020 - 2022",
    "exp.3.place": "Centro Medico Perpetuo Socorro",
    "exp.3.role": "Rotaciones Clinicas",
    "exp.3.desc": "Asistencia en consultas externas y procedimientos menores.",
    "edu.title": "Formacion Academica",
    "edu.1.date": "2025 - ACTUALIDAD",
    "edu.1.school": "UCV & European Medical College",
    "edu.1.title": "Master en Medicina Estetica y Rejuvenecimiento Integral",
    "edu.1.details": "Sede: Barcelona. En curso.",
    "edu.2.date": "2025 - ACTUALIDAD",
    "edu.2.school": "European Medical College",
    "edu.2.title": "Master en Medicina y Restauracion Capilar",
    "edu.2.details": "En curso.",
    "edu.3.date": "Enero 2026",
    "edu.3.school": "Ministerio de Sanidad",
    "edu.3.title": "Examen MIR",
    "edu.3.details": "Examen realizado el 24/01/2026.",
    "edu.4.date": "2016 - 2022",
    "edu.4.school": "Universidad Catolica Boliviana San Pablo",
    "edu.4.title": "Grado en Medicina y Cirugia",
    "edu.4.details": "Santa Cruz, Bolivia. Titulo homologado en Espana.",
    "contact.title": "Contacto Profesional",
    "contact.phone": "+34 617 893 031",
    "contact.email": "scarletdra@gmail.com",
    "contact.loc": "Barcelona, Espana",
    "footer.rights": "© 2026 Dr. Scarlet Perez. Todos los derechos reservados.",
    "btn.expand": "Ver toda la formacion",
    "btn.collapse": "Cerrar"
  },
  "en": {
    "nav.home": "Home",
    "nav.about": "Profile",
    "nav.education": "Education",
    "nav.experience": "Experience",
    "nav.contact": "Contact",
    "hero.name": "Dr. Scarlet Perez",
    "hero.subtitle": "AESTHETIC PHYSICIAN | SURGEON",
    "hero.cta": "CONTACT",
    "hero.uni": "Universidad Catolica Boliviana San Pablo",
    "hero.college_name": "Barcelona Medical College",
    "hero.col_num": "Colegiada no 69466",
    "about.title": "Professional Profile",
    "about.desc": "Medical Doctor with degree validated in Spain. Currently expanding specialization with Masters in Aesthetic Medicine and Hair Restoration. Practical experience in clinical care, emergencies and patient coordination. Committed to medical excellence and human care.",
    "exp.title": "Professional Experience",
    "exp.1.date": "2022",
    "exp.1.place": "National Health Fund - Bolivia",
    "exp.1.role": "Medical Internship",
    "exp.1.desc": "Complete rotations in Surgery, Pediatrics, Gynecology and Internal Medicine.",
    "exp.2.date": "2020 - 2022",
    "exp.2.place": "Expocruz Fair",
    "exp.2.role": "Support Physician / Emergencies",
    "exp.2.desc": "Primary emergency care, triage and stabilization.",
    "exp.3.date": "2020 - 2022",
    "exp.3.place": "Perpetuo Socorro Medical Center",
    "exp.3.role": "Clinical Rotations",
    "exp.3.desc": "Assistance in outpatient consultations and minor procedures.",
    "edu.title": "Education",
    "edu.1.date": "2025 - PRESENT",
    "edu.1.school": "UCV & European Medical College",
    "edu.1.title": "Master in Aesthetic Medicine and Comprehensive Rejuvenation",
    "edu.1.details": "Location: Barcelona. In progress.",
    "edu.2.date": "2025 - PRESENT",
    "edu.2.school": "European Medical College",
    "edu.2.title": "Master in Medicine and Hair Restoration",
    "edu.2.details": "In progress.",
    "edu.3.date": "January 2026",
    "edu.3.school": "Ministry of Health",
    "edu.3.title": "MIR Exam",
    "edu.3.details": "Exam taken on 24/01/2026.",
    "edu.4.date": "2016 - 2022",
    "edu.4.school": "Universidad Catolica Boliviana San Pablo",
    "edu.4.title": "Degree in Medicine and Surgery",
    "edu.4.details": "Santa Cruz, Bolivia. Degree validated in Spain.",
    "contact.title": "Professional Contact",
    "contact.phone": "+34 617 893 031",
    "contact.email": "scarletdra@gmail.com",
    "contact.loc": "Barcelona, Spain",
    "footer.rights": "© 2026 Dr. Scarlet Perez. All rights reserved.",
    "btn.expand": "See all education",
    "btn.collapse": "Close"
  },
  "ca": {
    "nav.home": "Inici",
    "nav.about": "Perfil",
    "nav.education": "Formacio",
    "nav.experience": "Experiencia",
    "nav.contact": "Contacte",
    "hero.name": "Dr. Scarlet Perez",
    "hero.subtitle": "METGE ESTETIC | CIRURGIA",
    "hero.cta": "CONTACTAR",
    "hero.uni": "Universidad Catolica Boliviana San Pablo",
    "hero.college_name": "Col.legi Medic de Barcelona",
    "hero.col_num": "Colegiada no 69466",
    "about.title": "Perfil Professional",
    "about.desc": "Metge Cirurgia amb titulacio homologada a Espanya. Actualment ampliant especialitzacio amb Masters en Medicina Estetica i Restauracio Capil.lar. Experiencia practica en atencio clinica, urgencies i coordinacio de pacients. Compromesa amb l'excel.lencia medica i el tracte huma.",
    "exp.title": "Experiencia Professional",
    "exp.1.date": "2022",
    "exp.1.place": "Caixa Nacional de Salut - Bolivia",
    "exp.1.role": "Internat Rotatori Medic",
    "exp.1.desc": "Rotacions completes en Cirurgia, Pediatria, Ginecologia i Medicina Interna.",
    "exp.2.date": "2020 - 2022",
    "exp.2.place": "Fira Expocruz",
    "exp.2.role": "Metge de Suport / Urgencies",
    "exp.2.desc": "Atencio primaria d'urgencies, triatge i estabilitzacio.",
    "exp.3.date": "2020 - 2022",
    "exp.3.place": "Centre Medic Perpetuo Socorro",
    "exp.3.role": "Rotacions Cliniques",
    "exp.3.desc": "Assistencia en consultes externes i procediments menors.",
    "edu.title": "Formacio Academica",
    "edu.1.date": "2025 - ACTUALITAT",
    "edu.1.school": "UCV & European Medical College",
    "edu.1.title": "Master en Medicina Estetica i Rejoveniment Integral",
    "edu.1.details": "Seu: Barcelona. En curs.",
    "edu.2.date": "2025 - ACTUALITAT",
    "edu.2.school": "European Medical College",
    "edu.2.title": "Master en Medicina i Restauracio Capil.lar",
    "edu.2.details": "En curs.",
    "edu.3.date": "Gener 2026",
    "edu.3.school": "Ministeri de Sanitat",
    "edu.3.title": "Examen MIR",
    "edu.3.details": "Examen realitzat el 24/01/2026.",
    "edu.4.date": "2016 - 2022",
    "edu.4.school": "Universidad Catolica Boliviana San Pablo",
    "edu.4.title": "Grau en Medicina i Cirurgia",
    "edu.4.details": "Santa Cruz, Bolivia. Titol homologat a Espanya.",
    "contact.title": "Contacte Professional",
    "contact.phone": "+34 617 893 031",
    "contact.email": "scarletdra@gmail.com",
    "contact.loc": "Barcelona, Espanya",
    "footer.rights": "© 2026 Dr. Scarlet Perez. Tots els drets reservats.",
    "btn.expand": "Veure tota la formacio",
    "btn.collapse": "Tancar"
  }
};

// DARK SECTIONS - Injected by generate.js
const darkSections = ["about","experience","contact"];

// EXPANDABLE TIMELINE LOGIC
window.toggleTimeline = function (id, btn) {
    const container = document.getElementById(id);
    const isCollapsed = container.classList.contains('collapsed');
    const currentLang = localStorage.getItem('preferredLang') || 'es';

    if (isCollapsed) {
        // EXPAND
        container.classList.remove('collapsed');
        container.classList.add('expanded');

        const span = btn.querySelector('span');
        const icon = btn.querySelector('ion-icon');
        if (span) span.textContent = translations[currentLang]["btn.collapse"] || "Cerrar";
        if (icon) icon.setAttribute('name', 'chevron-up-outline');

        container.scrollTop = 0;
    } else {
        // COLLAPSE
        container.classList.add('collapsed');
        container.classList.remove('expanded');

        const span = btn.querySelector('span');
        const icon = btn.querySelector('ion-icon');
        if (span) span.textContent = translations[currentLang]["btn.expand"] || "Ver todo";
        if (icon) icon.setAttribute('name', 'chevron-down-outline');

        container.scrollTop = 0;
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Language Switcher
    let currentLang = localStorage.getItem('preferredLang') || 'es';
    updateLanguage(currentLang);

    // Lang Switcher Interaction
    const langSwitcher = document.querySelector('.lang-switcher-bottom');
    if (langSwitcher) {
        langSwitcher.addEventListener('click', function (e) {
            const targetBtn = e.target.closest('.lang-btn-bottom');
            if (!targetBtn) return;

            if (this.classList.contains('expanded')) {
                if (!targetBtn.classList.contains('active')) {
                    const selectedLang = targetBtn.getAttribute('data-lang');
                    if (selectedLang) {
                        currentLang = selectedLang;
                        updateLanguage(currentLang);
                    }
                }
                this.classList.remove('expanded');
            } else {
                this.classList.add('expanded');
            }
        });

        document.addEventListener('click', function (e) {
            if (!langSwitcher.contains(e.target)) {
                langSwitcher.classList.remove('expanded');
            }
        });
    }

    // BURGER MENU LOGIC
    window.toggleBurgerMenu = function () {
        const burgerBtn = document.getElementById('burger-btn');
        const menuOverlay = document.getElementById('menu-overlay');
        const cutleryBurger = burgerBtn ? burgerBtn.querySelector('.cutlery-burger') : null;
        const bottomNav = document.querySelector('.bottom-nav');
        if (!burgerBtn || !menuOverlay) return;

        menuOverlay.classList.toggle('open');
        if (cutleryBurger) {
            cutleryBurger.classList.toggle('burger-open');
        }
        // Toggle gold colors when menu overlay is open (dark background)
        if (bottomNav) {
            bottomNav.classList.toggle('menu-open', menuOverlay.classList.contains('open'));
        }
    };

    // Close menu on link click — scroll within #app-scroller
    document.querySelectorAll('.menu-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const menuOverlay = document.getElementById('menu-overlay');
            const burgerBtn = document.getElementById('burger-btn');
            const bottomNav = document.querySelector('.bottom-nav');
            if (menuOverlay) menuOverlay.classList.remove('open');
            if (burgerBtn) {
                const cutleryBurger = burgerBtn.querySelector('.cutlery-burger');
                if (cutleryBurger) cutleryBurger.classList.remove('burger-open');
            }
            if (bottomNav) bottomNav.classList.remove('menu-open');

            // Scroll to section within #app-scroller
            const targetId = link.getAttribute('href').replace('#', '');
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.scrollIntoView({ behavior: 'auto', block: 'start' });
            }
        });
    });

    // Handle CTA button scroll within #app-scroller
    const ctaBtn = document.querySelector('.btn-primary[href="#contact"]');
    if (ctaBtn) {
        ctaBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const contactSection = document.getElementById('contact');
            if (contactSection) {
                contactSection.scrollIntoView({ behavior: 'auto', block: 'start' });
            }
        });
    }

    // Set initial nav color
    if (document.querySelector('.bottom-nav')) {
        document.querySelector('.bottom-nav').style.setProperty('--nav-adaptive-color', 'rgb(28,28,28)');
    }
});

// Adaptive nav colors — scroll-synced loop
function _navColorTick() {
    var nav = document.querySelector('.bottom-nav');
    var scroller = document.getElementById('app-scroller');
    if (!nav || !scroller) return;
    if (nav.classList.contains('menu-open')) return;

    var rect = scroller.getBoundingClientRect();
    var viewH = rect.height;
    if (viewH <= 0) return;

    var sections = document.querySelectorAll('header, section, footer');
    var dark = 0;

    for (var i = 0; i < sections.length; i++) {
        var s = sections[i];
        var sr = s.getBoundingClientRect();
        var vt = Math.max(sr.top, rect.top);
        var vb = Math.min(sr.bottom, rect.bottom);
        var vh = vb - vt;
        if (vh > 0 && darkSections.indexOf(s.id) !== -1) {
            dark += vh / viewH;
        }
    }

    dark = Math.min(1, Math.max(0, dark));
    var r = Math.round(28 + 156 * dark);
    var g = Math.round(28 + 121 * dark);
    var b = Math.round(28 + 78 * dark);
    nav.style.setProperty('--nav-adaptive-color', 'rgb(' + r + ',' + g + ',' + b + ')');
}
setInterval(_navColorTick, 16);

// Snap-visible detection
var _lastVisibleSection = null;
function _snapVisibleTick() {
    var scroller = document.getElementById('app-scroller');
    if (!scroller) return;

    var scrollerRect = scroller.getBoundingClientRect();
    var centerY = scrollerRect.top + scrollerRect.height / 2;

    var sections = document.querySelectorAll('header, section, footer');
    var bestSection = null;
    var bestOverlap = 0;

    for (var i = 0; i < sections.length; i++) {
        var s = sections[i];
        var sr = s.getBoundingClientRect();
        var vt = Math.max(sr.top, scrollerRect.top);
        var vb = Math.min(sr.bottom, scrollerRect.bottom);
        var vh = vb - vt;

        if (vh > bestOverlap) {
            bestOverlap = vh;
            bestSection = s;
        }
    }

    if (bestSection && bestSection !== _lastVisibleSection) {
        if (_lastVisibleSection) {
            _lastVisibleSection.classList.remove('snap-visible');
        }
        bestSection.classList.add('snap-visible');
        _lastVisibleSection = bestSection;

        // Auto-collapse timelines when leaving experience/education sections
        if (_lastVisibleSection &&
            (_lastVisibleSection.id === 'experience' || _lastVisibleSection.id === 'education')) {
            // Do nothing, user is viewing this section
        } else {
            var expandedTimelines = document.querySelectorAll('.timeline-container.expanded');
            expandedTimelines.forEach(function(tl) {
                var btn = tl.parentElement.querySelector('.btn-expand');
                if (btn) {
                    tl.classList.remove('expanded');
                    tl.classList.add('collapsed');
                    var span = btn.querySelector('span');
                    var icon = btn.querySelector('ion-icon');
                    var currentLang = localStorage.getItem('preferredLang') || 'es';
                    if (span) span.textContent = translations[currentLang]["btn.expand"] || "Ver todo";
                    if (icon) icon.setAttribute('name', 'chevron-down-outline');
                }
            });
        }
    }
}
setInterval(_snapVisibleTick, 100);

function updateLanguage(lang) {
    if (!translations[lang]) return;

    // Update text content
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang][key]) {
            el.textContent = translations[lang][key];
        }
    });

    // Update active button
    document.querySelectorAll('.lang-btn-bottom').forEach(btn => {
        if (btn.getAttribute('data-lang') === lang) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // Save preference
    localStorage.setItem('preferredLang', lang);
}
